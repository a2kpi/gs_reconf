define(function(require){var $=require("jquery");var storage=require("lmd/core/storage");var lectureZen=require("lmd/ui/lecture-zen");var Lightbox=require("lmd/ui/lightbox");var service=require("lmd/core/service");var auth=require("lmd/core/auth");var popinTemplate=require("hoganpower!/partials/layout/tracking/decouverte_zen_register.html.mu@www");var today=(new Date).getTime();var urlCheckout="https://checkout.lemonde.fr/gcheckout/cart/add/sku/S_DEC30J0PRLVT1FPRIO/";var xtorLectureZen="EREC-265-[LECTURE_ZEN]";
var xtor3PagesVues="EREC-265-[3PV]";var xtorFinal=null;var xitiTagPrefix="Inscription_offre_decouverte::Lemondefr::";var hit={med:function(tag){xt_med("F","19",xitiTagPrefix+tag)},form:function(form,tag){xt_form(form,"C","19",xitiTagPrefix+tag,"A",false)}};var lightbox={overlay:".fond_overlay.offre_decouverte",wrapper:".overlay.offre_decouverte",button:".js_fermer_offre_decouverte",top:85,overlayClose:false,overlaySpeedIn:250,overlaySpeedout:250};var discoveryParams={};var odzSingleton;var OffreDecouverteZen=
function(){var self=this;if(document.location.pathname==="/")return;if(lmd.conf.decouverte_no_count.indexOf(document.location.pathname)>=0)return;if(document.location.pathname===lmd.conf.url_teaser_ex_decouverte)return;if(typeof window.screen!=="undefined"&&typeof window.screen.width!=="undefined"&&window.screen.width<699)return;auth.loadUser().done(function(){if(!auth.authenticated||!auth.user.abonne)self.init()})};OffreDecouverteZen.prototype={init:function(){var self=this;var views=storage.get("lmd_decouverte_cpt")||
{page_count:0,already_shown:false,url:""};var period=12096E5;var exAbo=storage.get("lmd_decouverte")||{};if(views.url!==document.location.href&&!views.already_shown){var pageViewLimitReached=false;var isArticle=!!lmd.context.item&&lmd.context.item.type!==undefined&&lmd.context.item.type.nom!==undefined&&lmd.context.item.type.nom==="article";views.url=document.location.href;views.page_count++;pageViewLimitReached=views.page_count>=parseInt(lmd.conf.limit_wall);if(pageViewLimitReached&&isArticle){views.already_shown=
true;self.operation_id=lmd.conf.offre_decouverte_avec_abo_auto;self.afficherLectureZen();xtorFinal=xtor3PagesVues}storage.set("lmd_decouverte_cpt",views,period)}if(lectureZen.getInstance().bouton)lectureZen.getInstance().bouton.addClass("btn_offre_decouverte_zen").on("click",function(){self.boutonLectureZenXiti();self.operation_id=lmd.conf.offre_decouverte_zen_avec_abo_auto;self.afficherLectureZen();xtorFinal=xtorLectureZen})},afficherLectureZen:function(){var self=this;lectureZen.getInstance().open(function(){lectureZen.getInstance().lightbox.instance.disableClosing=
true;var count=0;var interval=setInterval(function(){count+=1E3;if(count>=lmd.conf.decouverte_zen_delay){self.afficherFormulaire();clearInterval(interval)}},1E3)})},afficherFormulaire:function(operation_id,operation_classname,template){var self=this;var tpl=template||popinTemplate;this.lightbox=new Lightbox(lightbox);this.lightbox.setLoader(true);this.lightbox.on("open",function(){if(lectureZen.getInstance().lightbox)lectureZen.getInstance().lightbox.instance.disableClosing=false;self.setupFormulaire();
self.loadXiti();$("#decouverte #no_thanks").click(function(){self.lightbox.close()})});this.lightbox.on("close",function(){if((!auth.authenticated||!auth.user.abonne)&&lectureZen.getInstance().lightbox)lectureZen.getInstance().lightbox.close();else lectureZen.getInstance().loadXiti()});discoveryParams=self.getDiscoveryParams();this.lightbox.open(tpl.render({conf:lmd.conf,operation_id:operation_id||self.operation_id,popin_class:operation_classname||discoveryParams.popinClass}))},setupFormulaire:function(){var self=
this;$("#decouverte").on("submit",function(event){event.preventDefault();self.hitXiti();self.poserParticipation(true);window.location.href=urlCheckout+"#xtor="+xtorFinal})},loadXiti:function(){var self=this;switch(self.operation_id){case lmd.conf.offre_decouverte_avec_abo_auto:hit.med("Affichage_formulaire");break;case lmd.conf.offre_decouverte_zen_avec_abo_auto:hit.med("Affichage_formulaire_bouton_lecture_zen");break}var img=document.createElement("img");img.src=lmd.conf.subscription.buttonViewCountUrl+
xtorFinal;img.width=1;img.height=1;document.body.appendChild(img)},hitXiti:function(){var self=this;var form=document.getElementById("decouverte");switch(self.operation_id){case lmd.conf.offre_decouverte_avec_abo_auto:hit.form(form,"Validation_formulaire");break;case lmd.conf.offre_decouverte_zen_avec_abo_auto:return hit.form(form,"Validation_formulaire_bouton_lecture_zen")}},boutonLectureZenXiti:function(){xt_click(lectureZen.getInstance().bouton.get(0),"C","19","Offre_decouverte::Lemonde.fr::Bouton_lecture_zen",
"A")},poserParticipation:function(abo){var expire_ts=5184E6;var date_fin_abo=today+2592E6;var user_cookie={is_abo:true,participation:today,date_abo:null,date_fin:date_fin_abo};if(abo)user_cookie.date_abo=today;storage.set("lmd_decouverte",user_cookie,expire_ts,false)},getDiscoveryParams:function(){var self=this;var config=JSON.parse(lmd.conf.decouverte_cb);switch(self.operation_id){case lmd.conf.offre_decouverte_avec_abo_auto:return config.pages;case lmd.conf.offre_decouverte_zen_avec_abo_auto:return config.zen}}};
odzSingleton=new OffreDecouverteZen;return{getInstance:function(){return odzSingleton}}});
